# REST API Plan

## 1. Resources

| Resource          | Database Table / View | Description                                                       |
| ----------------- | --------------------- | ----------------------------------------------------------------- |
| users             | auth.users            | Registered application users (managed by Supabase Auth)           |
| decks             | decks                 | Collection of flashcards grouped by a user-defined name           |
| flashcards        | flashcards            | Individual study cards containing `front` and `back` text         |
| aiGenerations     | ai_generations        | Single AI generation job producing one or more flashcards         |
| generationBatches | generation_batches    | Grouping of generation jobs submitted together                    |
| cardGenerations   | card_generations      | Junction between flashcards and AI generations                    |
| reviews           | reviews               | User-submitted SM-2 quality scores for a flashcard review session |
| events            | events                | Audit log of accept/edit/delete actions on flashcards             |
| backgroundJobs    | background_jobs       | Asynchronous system jobs (e.g. GDPR hard-delete)                  |
| metricsDaily      | metrics_daily (view)  | Daily KPI aggregates (read-only)                                  |

## 2. Endpoints

### 2.1 Authentication (Supabase handled)

---

### 2.2 Decks

| Method | Path                       | Description                                           |
| ------ | -------------------------- | ----------------------------------------------------- |
| GET    | /decks                     | List user decks (paginated)                           |
| POST   | /decks                     | Create a new deck                                     |
| GET    | /decks/{deckId}            | Retrieve deck details including card count            |
| PATCH  | /decks/{deckId}            | Update deck name or soft-delete flag                  |
| DELETE | /decks/{deckId}            | Soft-delete a deck (sets `deleted_at`)                |
| GET    | /decks/{deckId}/flashcards | List flashcards in a deck (supports reviewDue filter) |

**Query Parameters**

- `page`, `pageSize` – pagination (default 1, 20; max 100)
- `sort` – `created_at`, `name` (prefix with `-` for DESC)

**Request (POST /decks)**

```json
{
  "name": "Anatomy – Muscles"
}
```

**Response**

```json
{
  "id": "uuid",
  "name": "Anatomy – Muscles",
  "createdAt": "2025-10-09T12:00:00Z"
}
```

HTTP 200 for success, 400 for validation error (`name` required, 255 char max).

---

### 2.3 Flashcards

| Method | Path                 | Description                                                 |
| ------ | -------------------- | ----------------------------------------------------------- |
| GET    | /flashcards          | List user flashcards (global)                               |
| POST   | /flashcards          | Save flashcard entirely generated by ai, edited or manual   |
| GET    | /flashcards/{cardId} | Retrieve flashcard                                          |
| PATCH  | /flashcards/{cardId} | Edit front/back or deck assignment                          |
| DELETE | /flashcards/{cardId} | Soft-delete card                                            |
| POST   | /flashcards/generate | Generate flashcards via AI (creates generationBatch & jobs) |

**List Filters**

- `deckId` – UUID
- `reviewDue` – `now` (only cards whose `next_review_at` ≤ now)
- `search` – full-text search (uses `flashcards_search_idx`)

**Request (POST /flashcards)**

```json
{
  "front": "What is the capital of France?",
  "back": "Paris",
  "deckId": "uuid" // optional
}
```

Validation: `front`, `back` 1–1000 chars.

---

### 2.4 Flashcard Generation

| Method | Path                                 | Description                                       |
| ------ | ------------------------------------ | ------------------------------------------------- |
| POST   | /flashcards/generate                 | Submit text (1 000–10 000 chars); returns batchId |
| GET    | /generation-batches/{batchId}        | Poll batch status & jobs                          |
| GET    | /ai-generations/{generationId}       | Retrieve generation result (flashcards or error)  |
| POST   | /ai-generations/{generationId}/retry | Retry a failed generation                         |

**Request (POST /flashcards/generate)**

```json
{
  "deckId": "uuid", // optional – link generated cards to deck
  "sourceText": "<study text...>",
  "temperature": 0.7 // optional override
}
```

Returns `202 Accepted` with

```json
{
  "batchId": "uuid",
  "estimatedCardCount": 25
}
```

The job is processed asynchronously; client polls.

---

### 2.5 Reviews

| Method | Path           | Description                                              |
| ------ | -------------- | -------------------------------------------------------- |
| GET    | /reviews/queue | Get today’s due flashcards (ordered by `next_review_at`) |
| POST   | /reviews       | Submit review quality & latency                          |

**Request (POST /reviews)**

```json
{
  "flashcardId": "uuid",
  "quality": 4,
  "latencyMs": 3500
}
```

Validation: `quality` 0-5.
Response includes updated `easeFactor`, `intervalDays`, `nextReviewAt`.

---

### 2.6 Events (Audit)

| Method | Path    | Description                                            |
| ------ | ------- | ------------------------------------------------------ |
| GET    | /events | List accept/edit/delete events (filter by flashcardId) |

---

### 2.7 Metrics

Read-only endpoints for dashboards.

| Method | Path           | Description                                  |
| ------ | -------------- | -------------------------------------------- |
| GET    | /metrics/daily | KPI aggregates for current user (date range) |

Query: `startDate`, `endDate`.

---

### 2.8 Background Jobs (admin-only)

| Method | Path                     | Description     |
| ------ | ------------------------ | --------------- |
| GET    | /background-jobs         | List jobs       |
| POST   | /background-jobs         | Enqueue new job |
| GET    | /background-jobs/{jobId} | Job detail      |

Requires JWT with `service_role` claim.

## 3. Authentication & Authorization

- **AuthN**: Supabase’s email/password with JWT. All endpoints expect `Authorization: Bearer <token>`.
- **AuthZ**: PostgreSQL Row-Level Security policies enforce that `user_id = auth.uid()` except for `service_role`.
- **Scopes**: Standard users can only access their own rows; service role can access all.

## 4. Validation & Business Logic

### 4.1 Validation Rules

| Field                  | Rule                           |
| ---------------------- | ------------------------------ |
| deck.name              | required, ≤ 255 chars          |
| flashcard.front/back   | required, 1-1000 chars         |
| flashcard.source       | enum `AI` `MANUAL` `AI_EDITED` |
| flashcard.easeFactor   | ≥ 1.3, default 2.5             |
| flashcard.intervalDays | ≥ 0                            |
| aiGeneration.status    | `PENDING` `SUCCESS` `ERROR`    |
| review.quality         | int 0-5                        |
| generation input       | sourceText length 1000-10000   |

### 4.2 Business Logic Mapping

1. **Flashcard Acceptance (FR-03)** – When user taps "Accept", frontend calls `PATCH /flashcards/{id}` setting `source = 'AI'`, adds deck if pending.
2. **Inline Edit (FR-04/06)** – `PATCH /flashcards/{id}` updates `front`, `back`; triggers event row.
3. **SM-2 Scheduling (FR-06)** – `POST /reviews` runs server-side SM-2 algorithm updating flashcard scheduling columns.
4. **Daily Queue (FR-07)** – `GET /reviews/queue` selects from `flashcards_user_next_idx` where `next_review_at ≤ now()`.
5. **Account Deletion (FR-11)** – Frontend enqueues `POST /background-jobs` with `jobType = 'HARD_DELETE_USER'`.
6. **Metrics (FR-13)** – Nightly materialized view; endpoint is read-only.

## 5. Error Handling

| Status | Meaning                          |
| ------ | -------------------------------- |
| 400    | Validation error (details array) |
| 401    | Missing/invalid token            |
| 403    | Access forbidden (row RLS)       |
| 404    | Resource not found               |
| 409    | Conflict (e.g., duplicate name)  |
| 429    | Rate limit exceeded              |
| 500    | Unexpected server error          |

## 6. Pagination, Filtering, Sorting

- **Pagination**: Cursor-based (`page`, `pageSize`, optional `cursor`) or offset; responses include `nextCursor`.
- **Filtering**: Query params as listed above; unknown params ignored.
- **Sorting**: `sort` param with comma-separated fields; defaults per resource.

---

This plan aligns with Astro 5 + React 19 frontend, Supabase backend, and fulfills all functional and non-functional requirements stated in the PRD.
